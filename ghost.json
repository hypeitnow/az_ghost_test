{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1008.15138",
      "templateHash": "8936370020936205872"
    }
  },
  "parameters": {
    "applicationNamePrefix": {
      "type": "string",
      "defaultValue": "ghost",
      "metadata": {
        "description": "Prefix to use when creating the resources in this deployment."
      }
    },
    "appServicePlanSku": {
      "type": "string",
      "defaultValue": "S1",
      "metadata": {
        "description": "App Service Plan pricing tier"
      }
    },
    "logAnalyticsWorkspaceSku": {
      "type": "string",
      "defaultValue": "PerGB2018",
      "metadata": {
        "description": "Log Analytics workspace pricing tier"
      }
    },
    "storageAccountSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "metadata": {
        "description": "Storage account pricing tier"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy the resources"
      }
    },
    "mySQLServerSku": {
      "type": "string",
      "defaultValue": "B_Gen5_1",
      "metadata": {
        "description": "MySQL server SKU"
      }
    },
    "databasePassword": {
      "type": "secureString",
      "metadata": {
        "description": "MySQL server password"
      }
    },
    "ghostContainerName": {
      "type": "string",
      "defaultValue": "hypeitnow/ghost_mki:v1",
      "metadata": {
        "description": "Ghost container full image name and tag"
      }
    },
    "containerRegistryUrl": {
      "type": "string",
      "defaultValue": "https://index.docker.io/v1",
      "metadata": {
        "description": "Container registry where the image is hosted"
      }
    }
  },
  "functions": [],
  "variables": {
    "webAppName": "[format('{0}-web-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "webAppSlotName": "[format('{0}-web-test-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "appServicePlanName": "[format('{0}-asp-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "logAnalyticsWorkspaceName": "[format('{0}-la-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "applicationInsightsName": "[format('{0}-ai-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "keyVaultName": "[format('{0}-kv-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "storageAccountName": "[format('{0}stor{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "autoscaleSettingsName": "[format('{0}-autoscale-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "mySQLServerName": "[format('{0}-mysql-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "databaseLogin": "ghost",
    "databaseName": "ghost",
    "ghostContentFileShareName": "contentfiles",
    "ghostContentFilesMountPath": "/var/lib/ghost/content_files",
    "siteUrl": "[format('https://{0}.azurefd.net', variables('frontDoorName'))]",
    "frontDoorName": "[format('{0}-fd-{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]",
    "wafPolicyName": "[format('{0}waf{1}', parameters('applicationNamePrefix'), uniqueString(resourceGroup().id))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "logAnalyticsWorkspaceDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "logAnalyticsWorkspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "logAnalyticsWorkspaceSku": {
            "value": "[parameters('logAnalyticsWorkspaceSku')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "3160282134026138170"
            }
          },
          "parameters": {
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "maxLength": 64,
              "minLength": 4,
              "metadata": {
                "description": "Log Analytics workspace name"
              }
            },
            "logAnalyticsWorkspaceSku": {
              "type": "string",
              "allowedValues": [
                "Free",
                "LACluster",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "description": "Log Analytics workspace pricing tier"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "[parameters('logAnalyticsWorkspaceSku')]"
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "storageAccountDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "storageAccountSku": {
            "value": "[parameters('storageAccountSku')]"
          },
          "fileShareFolderName": {
            "value": "[variables('ghostContentFileShareName')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "12572391016932156243"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "maxLength": 24,
              "minLength": 3
            },
            "storageAccountSku": {
              "type": "string",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_ZRS"
              ]
            },
            "fileShareFolderName": {
              "type": "string",
              "metadata": {
                "description": "File share to store Ghost content files"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "kind": "StorageV2",
              "sku": {
                "name": "[parameters('storageAccountSku')]"
              },
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "StorageAccountDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/fileServices/{1}', parameters('storageAccountName'), 'default')]",
              "name": "FileServicesDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "StorageRead",
                    "enabled": true
                  },
                  {
                    "category": "StorageWrite",
                    "enabled": true
                  },
                  {
                    "category": "StorageDelete",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('fileShareFolderName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('storageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "fileShareFullName": {
              "type": "string",
              "value": "[parameters('fileShareFolderName')]"
            },
            "accessKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2021-04-01').keys[0].value]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "keyVaultDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "keyVaultSecretName": {
            "value": "databasePassword"
          },
          "keyVaultSecretValue": {
            "value": "[parameters('databasePassword')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          },
          "servicePrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.principalId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "2834323670296971079"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "maxLength": 24,
              "minLength": 3,
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "keyVaultSecretName": {
              "type": "string",
              "maxLength": 127,
              "minLength": 1,
              "metadata": {
                "description": "Secret name to store"
              }
            },
            "keyVaultSecretValue": {
              "type": "secureString",
              "metadata": {
                "description": "Secret value to store"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            },
            "servicePrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Service principal ID to provide access to the vault secrets"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-04-01-preview",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[parameters('servicePrincipalId')]",
                    "permissions": {
                      "secrets": [
                        "get"
                      ]
                    }
                  }
                ],
                "sku": {
                  "name": "standard",
                  "family": "A"
                },
                "enableSoftDelete": false
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2019-09-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('keyVaultSecretName'))]",
              "properties": {
                "value": "[parameters('keyVaultSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "KeyVaultDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "databasePasswordSecretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('keyVaultSecretName'))).secretUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'webAppDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "webAppDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "webAppName": {
            "value": "[variables('webAppName')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeploy'), '2020-06-01').outputs.id.value]"
          },
          "ghostContainerImage": {
            "value": "[parameters('ghostContainerName')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeploy'), '2020-06-01').outputs.name.value]"
          },
          "storageAccountAccessKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeploy'), '2020-06-01').outputs.accessKey.value]"
          },
          "fileShareName": {
            "value": "[variables('ghostContentFileShareName')]"
          },
          "containerMountPath": {
            "value": "[variables('ghostContentFilesMountPath')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "12722545764471613269"
            }
          },
          "parameters": {
            "webAppName": {
              "type": "string",
              "maxLength": 60,
              "minLength": 2
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan id to host the app"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            },
            "ghostContainerImage": {
              "type": "string",
              "metadata": {
                "description": "Ghost container full image name and tag"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name to store Ghost content files"
              }
            },
            "storageAccountAccessKey": {
              "type": "secureString"
            },
            "fileShareName": {
              "type": "string",
              "metadata": {
                "description": "File share name on the storage account to store Ghost content files"
              }
            },
            "containerMountPath": {
              "type": "string",
              "metadata": {
                "description": "Path to mount the file share in the container"
              }
            }
          },
          "functions": [],
          "variables": {
            "containerImageReference": "[format('DOCKER|{0}', parameters('ghostContainerImage'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-01-15",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "clientAffinityEnabled": true,
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "enabled": true,
                "reserved": true,
                "siteConfig": {
                  "http20Enabled": true,
                  "httpLoggingEnabled": true,
                  "minTlsVersion": "1.2",
                  "ftpsState": "Disabled",
                  "linuxFxVersion": "[variables('containerImageReference')]",
                  "alwaysOn": true,
                  "use32BitWorkerProcess": false,
                  "azureStorageAccounts": {
                    "ContentFilesVolume": {
                      "type": "AzureFiles",
                      "accountName": "[parameters('storageAccountName')]",
                      "shareName": "[parameters('fileShareName')]",
                      "mountPath": "[parameters('containerMountPath')]",
                      "accessKey": "[parameters('storageAccountAccessKey')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-01-15",
              "name": "[format('{0}/{1}', parameters('webAppName'), 'web')]",
              "properties": {
                "ipSecurityRestrictions": [
                  {
                    "ipAddress": "AzureFrontDoor.Backend",
                    "action": "Allow",
                    "tag": "ServiceTag",
                    "priority": 300,
                    "name": "Access from Azure Front Door",
                    "description": "Rule for access from Azure Front Door"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('webAppName'))]",
              "name": "WebAppDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceIPSecAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "hostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName'))).hostNames[0]]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2021-01-15', 'full').identity.principalId]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageAccountDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "webAppDeploySlot",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "webAppName": {
            "value": "[variables('webAppSlotName')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeploy'), '2020-06-01').outputs.id.value]"
          },
          "ghostContainerImage": {
            "value": "[parameters('ghostContainerName')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeploy'), '2020-06-01').outputs.name.value]"
          },
          "storageAccountAccessKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccountDeploy'), '2020-06-01').outputs.accessKey.value]"
          },
          "fileShareName": {
            "value": "[variables('ghostContentFileShareName')]"
          },
          "containerMountPath": {
            "value": "[variables('ghostContentFilesMountPath')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "12722545764471613269"
            }
          },
          "parameters": {
            "webAppName": {
              "type": "string",
              "maxLength": 60,
              "minLength": 2
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan id to host the app"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            },
            "ghostContainerImage": {
              "type": "string",
              "metadata": {
                "description": "Ghost container full image name and tag"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name to store Ghost content files"
              }
            },
            "storageAccountAccessKey": {
              "type": "secureString"
            },
            "fileShareName": {
              "type": "string",
              "metadata": {
                "description": "File share name on the storage account to store Ghost content files"
              }
            },
            "containerMountPath": {
              "type": "string",
              "metadata": {
                "description": "Path to mount the file share in the container"
              }
            }
          },
          "functions": [],
          "variables": {
            "containerImageReference": "[format('DOCKER|{0}', parameters('ghostContainerImage'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-01-15",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "clientAffinityEnabled": true,
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "enabled": true,
                "reserved": true,
                "siteConfig": {
                  "http20Enabled": true,
                  "httpLoggingEnabled": true,
                  "minTlsVersion": "1.2",
                  "ftpsState": "Disabled",
                  "linuxFxVersion": "[variables('containerImageReference')]",
                  "alwaysOn": true,
                  "use32BitWorkerProcess": false,
                  "azureStorageAccounts": {
                    "ContentFilesVolume": {
                      "type": "AzureFiles",
                      "accountName": "[parameters('storageAccountName')]",
                      "shareName": "[parameters('fileShareName')]",
                      "mountPath": "[parameters('containerMountPath')]",
                      "accessKey": "[parameters('storageAccountAccessKey')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-01-15",
              "name": "[format('{0}/{1}', parameters('webAppName'), 'web')]",
              "properties": {
                "ipSecurityRestrictions": [
                  {
                    "ipAddress": "AzureFrontDoor.Backend",
                    "action": "Allow",
                    "tag": "ServiceTag",
                    "priority": 300,
                    "name": "Access from Azure Front Door",
                    "description": "Rule for access from Azure Front Door"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('webAppName'))]",
              "name": "WebAppDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceIPSecAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "hostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName'))).hostNames[0]]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2021-01-15', 'full').identity.principalId]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageAccountDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "webAppSettingsDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "webAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.name.value]"
          },
          "applicationInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeploy'), '2020-06-01').outputs.ConnectionString.value]"
          },
          "applicationInsightsInstrumentationKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeploy'), '2020-06-01').outputs.InstrumentationKey.value]"
          },
          "containerRegistryUrl": {
            "value": "[parameters('containerRegistryUrl')]"
          },
          "containerMountPath": {
            "value": "[variables('ghostContentFilesMountPath')]"
          },
          "databaseHostFQDN": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'mySQLServerDeploy'), '2020-06-01').outputs.fullyQualifiedDomainName.value]"
          },
          "databaseLogin": {
            "value": "[format('{0}@{1}', variables('databaseLogin'), reference(resourceId('Microsoft.Resources/deployments', 'mySQLServerDeploy'), '2020-06-01').outputs.name.value)]"
          },
          "databasePasswordSecretUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeploy'), '2020-06-01').outputs.databasePasswordSecretUri.value]"
          },
          "databaseName": {
            "value": "[variables('databaseName')]"
          },
          "siteUrl": {
            "value": "[variables('siteUrl')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "8720769615157498605"
            }
          },
          "parameters": {
            "webAppName": {
              "type": "string"
            },
            "applicationInsightsInstrumentationKey": {
              "type": "string"
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "databaseHostFQDN": {
              "type": "string",
              "metadata": {
                "description": "MySQL server hostname"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Ghost datbase name"
              }
            },
            "databaseLogin": {
              "type": "string",
              "metadata": {
                "description": "Ghost database user name"
              }
            },
            "databasePasswordSecretUri": {
              "type": "string",
              "metadata": {
                "description": "Ghost database user password"
              }
            },
            "siteUrl": {
              "type": "string",
              "metadata": {
                "description": "Website URL to autogenerate links by Ghost"
              }
            },
            "containerMountPath": {
              "type": "string",
              "metadata": {
                "description": "Mount path for Ghost content files"
              }
            },
            "containerRegistryUrl": {
              "type": "string",
              "metadata": {
                "description": "Container registry to pull Ghost docker image"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-01-15",
              "name": "[format('{0}/{1}', parameters('webAppName'), 'appsettings')]",
              "properties": {
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('applicationInsightsInstrumentationKey')]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[parameters('applicationInsightsConnectionString')]",
                "ApplicationInsightsAgent_EXTENSION_VERSION": "~2",
                "XDT_MicrosoftApplicationInsights_Mode": "default",
                "WEBSITES_ENABLE_APP_SERVICE_STORAGE": "false",
                "DOCKER_REGISTRY_SERVER_URL": "[parameters('containerRegistryUrl')]",
                "WEBAPP_PORT": "2368",
                "NODE_ENV": "production",
                "GHOST_CONTENT": "[parameters('containerMountPath')]",
                "paths__contentPath": "[parameters('containerMountPath')]",
                "privacy_useUpdateCheck": "false",
                "url": "[parameters('siteUrl')]",
                "database__client": "mysql",
                "database__connection__host": "[parameters('databaseHostFQDN')]",
                "database__connection__user": "[parameters('databaseLogin')]",
                "database__connection__password": "[format('@Microsoft.KeyVault(SecretUri={0})', parameters('databasePasswordSecretUri'))]",
                "database__connection__database": "[parameters('databaseName')]",
                "database__connection__ssl": "true",
                "database__connection__ssl_minVersion": "TLSv1.2"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyVaultDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'mySQLServerDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'webAppDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "webAppSlotSettingsDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "webSlotAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploySlot'), '2020-06-01').outputs.name.value]"
          },
          "applicationInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeploy'), '2020-06-01').outputs.ConnectionString.value]"
          },
          "applicationInsightsInstrumentationKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeploy'), '2020-06-01').outputs.InstrumentationKey.value]"
          },
          "containerRegistryUrl": {
            "value": "[parameters('containerRegistryUrl')]"
          },
          "containerMountPath": {
            "value": "[variables('ghostContentFilesMountPath')]"
          },
          "databaseHostFQDN": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'mySQLServerDeploy'), '2020-06-01').outputs.fullyQualifiedDomainName.value]"
          },
          "databaseLogin": {
            "value": "[format('{0}@{1}', variables('databaseLogin'), reference(resourceId('Microsoft.Resources/deployments', 'mySQLServerDeploy'), '2020-06-01').outputs.name.value)]"
          },
          "databasePasswordSecretUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeploy'), '2020-06-01').outputs.databasePasswordSecretUri.value]"
          },
          "databaseName": {
            "value": "[variables('databaseName')]"
          },
          "siteUrl": {
            "value": "[variables('siteUrl')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "16836096406428267446"
            }
          },
          "parameters": {
            "webSlotAppName": {
              "type": "string"
            },
            "applicationInsightsInstrumentationKey": {
              "type": "string"
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "databaseHostFQDN": {
              "type": "string",
              "metadata": {
                "description": "MySQL server hostname"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Ghost datbase name"
              }
            },
            "databaseLogin": {
              "type": "string",
              "metadata": {
                "description": "Ghost database user name"
              }
            },
            "databasePasswordSecretUri": {
              "type": "string",
              "metadata": {
                "description": "Ghost database user password"
              }
            },
            "siteUrl": {
              "type": "string",
              "metadata": {
                "description": "Website URL to autogenerate links by Ghost"
              }
            },
            "containerMountPath": {
              "type": "string",
              "metadata": {
                "description": "Mount path for Ghost content files"
              }
            },
            "containerRegistryUrl": {
              "type": "string",
              "metadata": {
                "description": "Container registry to pull Ghost docker image"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-01-15",
              "name": "[format('{0}/{1}', parameters('webSlotAppName'), 'appsettings')]",
              "properties": {
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('applicationInsightsInstrumentationKey')]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[parameters('applicationInsightsConnectionString')]",
                "ApplicationInsightsAgent_EXTENSION_VERSION": "~2",
                "XDT_MicrosoftApplicationInsights_Mode": "default",
                "WEBSITES_ENABLE_APP_SERVICE_STORAGE": "false",
                "DOCKER_REGISTRY_SERVER_URL": "[parameters('containerRegistryUrl')]",
                "WEBAPP_PORT": "2368",
                "DOCKER_ENABLE_CI": "true",
                "NODE_ENV": "development",
                "GHOST_CONTENT": "[parameters('containerMountPath')]",
                "paths__contentPath": "[parameters('containerMountPath')]",
                "privacy_useUpdateCheck": "false",
                "url": "[parameters('siteUrl')]",
                "database__client": "mysql",
                "database__connection__host": "[parameters('databaseHostFQDN')]",
                "database__connection__user": "[parameters('databaseLogin')]",
                "database__connection__password": "[format('@Microsoft.KeyVault(SecretUri={0})', parameters('databasePasswordSecretUri'))]",
                "database__connection__database": "[parameters('databaseName')]",
                "database__connection__ssl": "true",
                "database__connection__ssl_minVersion": "TLSv1.2"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyVaultDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'mySQLServerDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'webAppDeploySlot')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "appServicePlanDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanName": {
            "value": "[variables('appServicePlanName')]"
          },
          "appServicePlanSku": {
            "value": "[parameters('appServicePlanSku')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "5695594374245595161"
            }
          },
          "parameters": {
            "appServicePlanName": {
              "type": "string",
              "maxLength": 40,
              "minLength": 1,
              "metadata": {
                "description": "App Service Plan name"
              }
            },
            "appServicePlanSku": {
              "type": "string",
              "allowedValues": [
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1v2",
                "P2v2",
                "P3v2"
              ],
              "metadata": {
                "description": "App Service Plan pricing tier"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-01-15",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "properties": {
                "reserved": true
              },
              "sku": {
                "name": "[parameters('appServicePlanSku')]"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/serverfarms/{0}', parameters('appServicePlanName'))]",
              "name": "AppServicePlanDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "applicationInsightsDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "applicationInsightsName": {
            "value": "[variables('applicationInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeploy'), '2020-06-01').outputs.id.value]"
          },
          "autoscaleName": {
            "value": "[variables('autoscaleSettingsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "7264001984550697903"
            }
          },
          "parameters": {
            "applicationInsightsName": {
              "type": "string",
              "maxLength": 260,
              "minLength": 1,
              "metadata": {
                "description": "Application Insights name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "webAppServicePlan id for autoscale setiings"
              }
            },
            "autoscaleName": {
              "type": "string",
              "metadata": {
                "description": "webAppServicePlan name for autoscale setiings"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Insights/components/{0}', parameters('applicationInsightsName'))]",
              "name": "InsightsDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "AppAvailabilityResults",
                    "enabled": true
                  },
                  {
                    "category": "AppBrowserTimings",
                    "enabled": true
                  },
                  {
                    "category": "AppEvents",
                    "enabled": true
                  },
                  {
                    "category": "AppMetrics",
                    "enabled": true
                  },
                  {
                    "category": "AppDependencies",
                    "enabled": true
                  },
                  {
                    "category": "AppExceptions",
                    "enabled": true
                  },
                  {
                    "category": "AppPageViews",
                    "enabled": true
                  },
                  {
                    "category": "AppPerformanceCounters",
                    "enabled": true
                  },
                  {
                    "category": "AppRequests",
                    "enabled": true
                  },
                  {
                    "category": "AppSystemEvents",
                    "enabled": true
                  },
                  {
                    "category": "AppTraces",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/autoscalesettings",
              "apiVersion": "2015-04-01",
              "name": "[parameters('autoscaleName')]",
              "location": "[parameters('location')]",
              "properties": {
                "name": "[parameters('autoscaleName')]",
                "enabled": true,
                "profiles": [
                  {
                    "name": "Auto created scale condition",
                    "capacity": {
                      "minimum": "1",
                      "maximum": "4",
                      "default": "1"
                    },
                    "rules": [
                      {
                        "scaleAction": {
                          "direction": "Increase",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT5M"
                        },
                        "metricTrigger": {
                          "metricName": "CpuPercentage",
                          "metricNamespace": "microsoft.web/serverfarms",
                          "operator": "GreaterThan",
                          "statistic": "Average",
                          "threshold": 85,
                          "timeAggregation": "Average",
                          "timeGrain": "PT1M",
                          "timeWindow": "PT10M",
                          "metricResourceUri": "[parameters('appServicePlanId')]",
                          "dividePerInstance": false
                        }
                      }
                    ]
                  }
                ],
                "notifications": [],
                "targetResourceLocation": "Germany West Central",
                "targetResourceUri": "[parameters('appServicePlanId')]"
              }
            }
          ],
          "outputs": {
            "InstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))).InstrumentationKey]"
            },
            "ConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))).ConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "mySQLServerDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "administratorLogin": {
            "value": "[variables('databaseLogin')]"
          },
          "administratorPassword": {
            "value": "[parameters('databasePassword')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          },
          "mySQLServerName": {
            "value": "[variables('mySQLServerName')]"
          },
          "mySQLServerSku": {
            "value": "[parameters('mySQLServerSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "6551355420977015190"
            }
          },
          "parameters": {
            "mySQLServerName": {
              "type": "string",
              "maxLength": 63,
              "minLength": 3
            },
            "mySQLServerSku": {
              "type": "string",
              "allowedValues": [
                "B_Gen5_1",
                "B_Gen5_2"
              ]
            },
            "administratorLogin": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "Database administrator login name"
              }
            },
            "administratorPassword": {
              "type": "secureString",
              "maxLength": 128,
              "minLength": 8,
              "metadata": {
                "description": "Database administrator password"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resources"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.DBforMySQL/servers",
              "apiVersion": "2017-12-01",
              "name": "[parameters('mySQLServerName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('mySQLServerSku')]",
                "tier": "Basic"
              },
              "properties": {
                "createMode": "Default",
                "version": "5.7",
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]",
                "sslEnforcement": "Enabled",
                "minimalTlsVersion": "TLS1_2"
              }
            },
            {
              "type": "Microsoft.DBforMySQL/servers/firewallRules",
              "apiVersion": "2017-12-01",
              "name": "[format('{0}/{1}', parameters('mySQLServerName'), 'AllowAzureIPs')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/servers', parameters('mySQLServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DBforMySQL/servers/{0}', parameters('mySQLServerName'))]",
              "name": "MySQLServerDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "MySqlSlowLogs",
                    "enabled": true
                  },
                  {
                    "category": "MySqlAuditLogs",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/servers', parameters('mySQLServerName'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('mySQLServerName')]"
            },
            "fullyQualifiedDomainName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DBforMySQL/servers', parameters('mySQLServerName'))).fullyQualifiedDomainName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "FrontDoorDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "frontDoorName": {
            "value": "[variables('frontDoorName')]"
          },
          "wafPolicyName": {
            "value": "[variables('wafPolicyName')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy'), '2020-06-01').outputs.id.value]"
          },
          "webAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "2104711094536948318"
            }
          },
          "parameters": {
            "frontDoorName": {
              "type": "string",
              "maxLength": 64,
              "minLength": 5
            },
            "wafPolicyName": {
              "type": "string",
              "maxLength": 128,
              "minLength": 1
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace id to use for diagnostics settings"
              }
            },
            "webAppName": {
              "type": "string",
              "metadata": {
                "description": "Web app to confire Front Door for"
              }
            }
          },
          "functions": [],
          "variables": {
            "backendPool1Name": "[format('{0}-backendPool1', parameters('frontDoorName'))]",
            "healthProbe1Name": "[format('{0}-healthProbe1', parameters('frontDoorName'))]",
            "frontendEndpoint1Name": "[format('{0}-frontendEndpoint1', parameters('frontDoorName'))]",
            "loadBalancing1Name": "[format('{0}-loadBalancing1', parameters('frontDoorName'))]",
            "routingRule1Name": "[format('{0}-routingRule1', parameters('frontDoorName'))]",
            "frontendEndpoint1hostName": "[format('{0}.azurefd.net', parameters('frontDoorName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/frontDoors",
              "apiVersion": "2020-05-01",
              "name": "[parameters('frontDoorName')]",
              "location": "global",
              "properties": {
                "routingRules": [
                  {
                    "name": "[variables('routingRule1Name')]",
                    "properties": {
                      "frontendEndpoints": [
                        {
                          "id": "[resourceId('Microsoft.Network/frontDoors/frontendEndpoints', parameters('frontDoorName'), variables('frontendEndpoint1Name'))]"
                        }
                      ],
                      "acceptedProtocols": [
                        "Http",
                        "Https"
                      ],
                      "patternsToMatch": [
                        "/*"
                      ],
                      "routeConfiguration": {
                        "@odata.type": "#Microsoft.Azure.FrontDoor.Models.FrontdoorForwardingConfiguration",
                        "forwardingProtocol": "HttpsOnly",
                        "backendPool": {
                          "id": "[resourceId('Microsoft.Network/frontDoors/backendPools', parameters('frontDoorName'), variables('backendPool1Name'))]"
                        },
                        "cacheConfiguration": {
                          "queryParameterStripDirective": "StripNone",
                          "dynamicCompression": "Enabled"
                        }
                      },
                      "enabledState": "Enabled"
                    }
                  }
                ],
                "healthProbeSettings": [
                  {
                    "name": "[variables('healthProbe1Name')]",
                    "properties": {
                      "path": "/",
                      "protocol": "Https",
                      "intervalInSeconds": 120
                    }
                  }
                ],
                "loadBalancingSettings": [
                  {
                    "name": "[variables('loadBalancing1Name')]",
                    "properties": {
                      "sampleSize": 4,
                      "successfulSamplesRequired": 2
                    }
                  }
                ],
                "backendPools": [
                  {
                    "name": "[variables('backendPool1Name')]",
                    "properties": {
                      "backends": [
                        {
                          "address": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2020-09-01').defaultHostName]",
                          "backendHostHeader": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2020-09-01').defaultHostName]",
                          "httpPort": 80,
                          "httpsPort": 443,
                          "weight": 50,
                          "priority": 1,
                          "enabledState": "Enabled"
                        }
                      ],
                      "loadBalancingSettings": {
                        "id": "[resourceId('Microsoft.Network/frontDoors/loadBalancingSettings', parameters('frontDoorName'), variables('loadBalancing1Name'))]"
                      },
                      "healthProbeSettings": {
                        "id": "[resourceId('Microsoft.Network/frontDoors/healthProbeSettings', parameters('frontDoorName'), variables('healthProbe1Name'))]"
                      }
                    }
                  }
                ],
                "frontendEndpoints": [
                  {
                    "name": "[variables('frontendEndpoint1Name')]",
                    "properties": {
                      "hostName": "[variables('frontendEndpoint1hostName')]",
                      "sessionAffinityEnabledState": "Disabled",
                      "webApplicationFirewallPolicyLink": {
                        "id": "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', parameters('wafPolicyName'))]"
                      }
                    }
                  }
                ],
                "enabledState": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', parameters('wafPolicyName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Network/frontDoors/{0}', parameters('frontDoorName'))]",
              "name": "FrontDoorDiagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "logs": [
                  {
                    "category": "FrontdoorAccessLog",
                    "enabled": true
                  },
                  {
                    "category": "FrontdoorWebApplicationFirewallLog",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/frontDoors', parameters('frontDoorName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/FrontDoorWebApplicationFirewallPolicies",
              "apiVersion": "2020-11-01",
              "name": "[parameters('wafPolicyName')]",
              "location": "global",
              "properties": {
                "policySettings": {
                  "mode": "Prevention",
                  "enabledState": "Enabled"
                },
                "managedRules": {
                  "managedRuleSets": [
                    {
                      "ruleSetType": "Microsoft_DefaultRuleSet",
                      "ruleSetVersion": "1.1"
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "frontendEndpointHostName": {
              "type": "string",
              "value": "[variables('frontendEndpoint1hostName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'webAppDeploy')]"
      ]
    }
  ],
  "outputs": {
    "webAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.name.value]"
    },
    "webAppPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.principalId.value]"
    },
    "webAppHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.hostName.value]"
    },
    "webSlotAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.name.value]"
    },
    "webAppSlotPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.principalId.value]"
    },
    "webAppSlotHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'webAppDeploy'), '2020-06-01').outputs.hostName.value]"
    },
    "endpointHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'FrontDoorDeploy'), '2020-06-01').outputs.frontendEndpointHostName.value]"
    }
  }
}